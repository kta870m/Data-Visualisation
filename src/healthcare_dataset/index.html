<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Data - Pie Chart with Tooltip</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border-radius: 8px;
            pointer-events: none;
        }
        svg {
            font-family: Arial, sans-serif;
        }
        .label {
            font-size: 12px;
            text-anchor: middle;
            fill: white;
        }
    </style>
</head>
<body>

<h2>Healthcare Data: Distribution of Medical Conditions</h2>
<div id="chart"></div>

<script>
// Set up the dimensions and radius of the pie chart
const width = 500, height = 500, radius = Math.min(width, height) / 2;
const svg = d3.select("#chart").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", `translate(${width / 2}, ${height / 2})`);

// Tooltip setup
const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

// Load the CSV file
d3.csv("../../data/result/healthcare_dataset.csv").then(data => {
    // Process data to get counts for each Medical Condition
    const conditionCounts = d3.rollup(data, v => v.length, d => d["Medical Condition"]);
    const pieData = Array.from(conditionCounts, ([condition, count]) => ({condition, count}));

    // Color scale
    const color = d3.scaleOrdinal(d3.schemeCategory10);

    // Generate the pie chart layout
    const pie = d3.pie()
        .value(d => d.count)
        .sort(null);

    // Generate arcs
    const arc = d3.arc()
        .innerRadius(0)
        .outerRadius(radius);

    // Generate arc for label position
    const labelArc = d3.arc()
        .innerRadius(radius * 0.5) // Set the position of labels inside the slices
        .outerRadius(radius * 0.5);

    // Bind data to pie chart
    const arcs = svg.selectAll("arc")
        .data(pie(pieData))
        .enter().append("g")
        .attr("class", "arc");

    // Draw each slice of the pie
    arcs.append("path")
        .attr("d", arc)
        .attr("fill", d => color(d.data.condition))
        .on("mouseover", (event, d) => {
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip.html(`<strong>${d.data.condition}</strong>: ${d.data.count} patients`)
                .style("left", (event.pageX + 5) + "px")
                .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", () => {
            tooltip.transition().duration(500).style("opacity", 0);
        });

    // Add labels to each slice
    arcs.append("text")
        .attr("transform", d => `translate(${labelArc.centroid(d)})`)
        .attr("class", "label")
        .text(d => `${d.data.condition}: ${d.data.count}`);
        
}).catch(error => {
    console.error('Error loading or processing data:', error);
});
</script>

</body>
</html>
