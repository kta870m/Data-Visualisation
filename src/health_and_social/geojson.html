<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D World Map with D3</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf"></script>

    <style>
        .country {
            stroke: #fff;
            stroke-width: 0.3;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="globe"></div>

<script>
    const width = 960, height = 600;
    const svg = d3.select("#globe").append("svg")
        .attr("width", width)
        .attr("height", height);

    const projection = d3.geoEquirectangular() // Changed to equirectangular projection
        .scale(160) // Adjust the scale as necessary
        .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // Load data and render map
    Promise.all([
        d3.json("map.json").catch(error => console.error("GeoJSON file not found:", error)), 
        d3.csv("../data/result/health_and_social.csv").catch(error => console.error("CSV file not found:", error))
    ]).then(([geoData, csvData]) => {
        if (!geoData || !csvData) {
            console.error("Data loading failed.");
            return;
        }
        geoData.features.map(d => d.properties = {iso_a3: d.properties.iso_a3, name: d.properties.name});
        console.log(geoData);
        const data = {};
        csvData.forEach(d => {
            data[d.COU] = +d.Value; 
        });

        const colorScale = d3.scalePow()
            .exponent(0.4)
            .domain([0, Math.max(...Object.values(data))])
            .range(["#ffffff", "#0a8dd9"]);

        svg.selectAll("path")
            .data(geoData.features)
            .enter().append("path")
            .attr("class", "country")
            .attr("fill", d => {
                const value = data[d.properties.iso_a3];
                return value ? colorScale(value) : "#ccc";
            })
            .attr("d", path)
            .on("mouseover", (event, d) => {
                const value = data[d.properties.iso_a3];
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`<strong>${d.properties.name}</strong><br>Value: ${value || "N/A"}`)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", () => {
                tooltip.transition().duration(500).style("opacity", 0);
            });
    }).catch(error => {
        console.error('Error loading or parsing data:', error);
    });
</script>

</body>
</html>
